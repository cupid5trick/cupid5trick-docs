---
title: Untitled
author: cupid5trick
created: 2023-04-14 20:47
tags: 
categories: 
access: private
draft: true
lang:
- zh-cn
- en-us
abstract: 强引用不回收、软引用内存不足即回收、弱引用发现即回收、虚引用用于对象回收跟踪
keywords:
---
# Java 引用类型
## 功能

`java.lang.ref` 包提供引用对象类型，允许程序和垃圾收集器之间一定程度的交互。程序可以使用引用对象来维护对某个其他对象的引用，这样后者的对象依然可以被垃圾收集器回收。也可以通过引用队列（ `ReferenceQuene` ）安排程序在所引用的对象可达性发生变化时得到通知。

`java.lang.ref` 提供了 `SoftReference` 、 `WeakReference` 和 `PhantomReference` 共三种引用类型，每一种都比前一种的引用程度更弱。三种引用类型以及常规的对象引用（称为强引用）在垃圾收集中对应了不同的可达性。简单来说，**强引用不回收、软引用内存不足即回收、弱引用发现即回收、虚引用用于对象回收跟踪**。

- 软引用可以用于实现对内存敏感的缓存
- 弱引用可以用于实现不阻止其键（或值）被回收的规范化映射
- 虚引用可以利用 Java 的 finalization 机制调度事前清理操作

每个引用对象类型都由抽象基类[`Reference`]( https://docs.oracle.com/javase/7/docs/api/java/lang/ref/Reference.html) 的子类实现。这些子类之一的实例封装了对特定对象的单个引用，称为*referent*。每个引用对象都提供获取和清除引用的方法。除了清除操作之外，引用对象在其他方面是不可变的，因此不提供任何 `set` 操作。程序可以继承这些子类，添加所需的任何字段和方法，或者也可以直接使用这些子类。

## 通知

在创建引用对象时，向构造函数提供一个 `ReferenceQuene` 类型的参数，垃圾收集器将通过向引用队列注册适当的引用对象，来通知对象可达性的变化。垃圾收集器确定**引用对象的可达性已更改为与引用类型对应的值**以后，它会将引用添加到关联的队列中。程序可以通过轮询或阻塞的方式从队列中删除引用，直到引用可用。引用队列由 [`ReferenceQueue`](https://docs.oracle.com/javase/7/docs/api/java/lang/ref/ReferenceQueue.html "class in java.lang.ref") 类实现。 

已注册的引用对象与其队列之间的关系是单向的。也就是说，队列不会跟踪向其注册的引用。如果注册的引用本身变得不可访问，那么它永远不会被排队。使用引用对象的程序有责任确保只要程序对引用对象感兴趣，对象就可以访问。

虽然一些程序会专门设计一个线程，从一个或多个队列中移除引用对象并对其进行处理，但这不是必需的。一种通常很有效的策略是在执行其他一些相当频繁的操作时检查引用队列。例如，使用弱引用实现 `WeakHashMap` 可以在每次访问表时轮询其引用队列。这就是 [`WeakHashMap`]( https://docs.oracle.com/javase/7/docs/api/java/util/WeakHashMap.html "class in java.util") 类型的运作方式。因为  [`ReferenceQueue.poll`](https://docs.oracle.com/javase/7/docs/api/java/lang/ref/ReferenceQueue.html#poll()) 方法只是检查内部数据结构，所以这种检查不会增加哈希表访问方法的开销。

## 自动清除引用

**软引用和弱引用**在被添加到它们注册的队列（如果有的话）之前会被收集器自动清除。因此，软引用和弱引用不在引用队列中注册也能使用，而使用虚引用时必须将其注册到一个引用队列中（也就是使用带引用队列的构造函数）。**通过虚引用可访问的对象将保持此状态，直到所有此类引用都被清除或它们自身变得不可访问为止。**

## 可达性

从最强到最弱，不同级别的可达性反映了对象的生命周期。它们在操作上定义如下：

-   如果某个线程可以在不遍历任何引用对象的情况下访问某个对象，则该对象是*强可达*的。新创建的对象可以被创建它的线程强访问。
-   如果一个对象不是强可达但可以通过遍历软引用到达，则该对象是软可达的。
-   如果一个对象既不是强可达的也不是软可达的，但可以通过遍历弱引用到达，则该对象是弱可达的。当对弱可达对象的弱引用被清除时，该对象就有资格进行终结。
-   如果一个对象既不是强可达、软可达也不是弱可达，则它是幻影可达的，它已经完成，并且有一些幻影引用引用它。
-   最后，当对象无法通过上述任何一种方式到达时，该对象是无法到达的，因此有资格回收。


- [一文读懂java中的Reference和引用类型 - 腾讯云开发者社区-腾讯云](https://cloud.tencent.com/developer/article/1657759): <https://cloud.tencent.com/developer/article/1657759>

- [(212条消息) 深入探讨 java.lang.ref 包_GavinCook的博客-CSDN博客](https://blog.csdn.net/gavincook/article/details/21377579): <https://blog.csdn.net/gavincook/article/details/21377579>


---
scope: work
draft: true
---
# 协同功能调研

- 基于 WebRTC 实现点对点的实时音视频、数据流、事件流
- websocket 进行冲突解决、状态同步

## 参考资料

**一些冲突解决方案**
- [百度 FEX：实时协同编辑的实现](https://fex.baidu.com/blog/2014/04/realtime-collaboration/)


**WebRTC 资料**

- **[Google WebRTC Guide](https://webrtc.org/getting-started/overview)** & **[Google WebRTC Slides](http://io13webrtc.appspot.com/)**
- [Google Docs：WebRTC resources](https://docs.google.com/document/d/1idl_NYQhllFEFqkGQOLv8KBK8M3EVzyvxnKkHl4SuM8/edit)
- [Media Capture and Streams](https://w3c.github.io/mediacapture-main/)

- [Stack Overflow：WebRTC vs Websockets](https://stackoverflow.com/questions/18799364/webrtc-vs-websockets-if-webrtc-can-do-video-audio-and-data-why-do-i-need-web)
- [Stack Overflow：Video streaming over websockets using JavaScript](https://stackoverflow.com/questions/4241992/video-streaming-over-websockets-using-javascript)
-  2013 Google I/O [presentation](http://www.youtube.com/watch?v=p2HzZkd2A40) about WebRTC
- [知乎：WebRTC入门与提高-WebRTC原理(STUN/TURN/SDP)](https://zhuanlan.zhihu.com/p/79489847)
- [知乎：浅聊 WebRTC 视频通话](https://zhuanlan.zhihu.com/p/412886513)
- [知乎：WebRTC 媒体服务器](https://zhuanlan.zhihu.com/p/33616446)
- [博客园：P2P通信标准协议 - ICE](https://www.cnblogs.com/pannengzhi/p/5061674.html)
- [博客园：WebRTC 信令服务器的另一种实现方式-无需掌握全部的socket.io](https://www.cnblogs.com/eflypro/p/14610640.html)


## 音视频、数据流

[知乎：WebRTC入门与提高-WebRTC原理(STUN/TURN/SDP)](https://zhuanlan.zhihu.com/p/79489847)

[WebRTC 概述](WebRTC%20概述.md)

通过 STUN 和 TURN 协议的服务器建立点对点网络连接，信令服务器（signaling）转发流数据。

- 开源的 STUN/TURN 服务器 coturn：[coturn 功能特性](coturn%20功能特性.md)<github.com/coturn/coturn>

### 媒体服务器产品

**Jitsi**
- homepage: <https://jitsi.org/>
- documentation: <https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-manual>
- github: <https://github.com/jitsi/jitsi>
- [Jitsi 部署和开发文档](Jitsi%20部署和开发文档)

**Kurento**

- homepage （底层 API）: <https://kurento.org>
- documentation: <https://doc-kurento.readthedocs.io/en/latest/index.html>
- github: <https://github.com/kurento/kurento-media-server>
- 常见使用场景的高级 API: <https://openvidu.io>
- [Kurento 部署和开发文档](Kurento%20部署和开发文档.md)



## 冲突解决
[百度 FEX：实时协同编辑的实现](https://fex.baidu.com/blog/2014/04/realtime-collaboration/)

要实现实时编辑，我们需要解决两个技术点：实时通信问题、编辑冲突问题，其中实时通信问题比较好解决，可以使用 long pull 或 WebSocket，所以这里就不过多讨论了，重点将放在如何解决编辑冲突问题上。


接下来将从易至难的顺序来介绍几种可行的方案，分别是：「编辑锁」、「GNU diff-patch」、「Myer’s diff-patch」、「Operational Transformation」和「分布式 Operational Transformation」。








# miro

<https://miro.com>

- websocket: <wss://miro.com/ws/board-070421dd5bce504ab?client_auth_user_id=3458764516215837984> 推送和接受二进制数据

- clientQos

  ```js
  fetch("https://hlg.tokbox.com/prod/logging/ClientQos", {
    "headers": {
      "accept": "text/plain",
      "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
      "content-type": "application/json",
      "sec-ch-ua": "\" Not;A Brand\";v=\"99\", \"Google Chrome\";v=\"97\", \"Chromium\";v=\"97\"",
      "sec-ch-ua-mobile": "?0",
      "sec-ch-ua-platform": "\"Windows\"",
      "sec-fetch-dest": "empty",
      "sec-fetch-mode": "cors",
      "sec-fetch-site": "cross-site",
      "Referer": "https://miro.com/",
      "Referrer-Policy": "origin"
    },
    "body": "{\"guid\":\"a1ca9710-386e-4f0d-933e-fcba8fa89b52\",\"duration\":120,\"clientVersion\":\"js-2.21.2\",\"buildHash\":\"36aba9d71\",\"source\":\"https://miro.com/app/board/uXjVOXYiRO4=/\",\"logVersion\":\"2\",\"apiServer\":\"https://api-standard.opentok.com\",\"clientSystemTime\":1641740377546,\"sessionId\":\"1_MX4zOTA2Nzc4Mn5-MTY0MTczOTAyOTY3NH43ZUNnYmdyLzBEVUYzcW9LZUlZM1dGbUt-fg\",\"mediaServerName\":\"mantis151-hnd.tokbox.com\",\"relayServer\":\"turnserver-5699b5d845-9b7xw-apne1.proxy.prod.tokbox.com\",\"p2p\":false,\"messagingServer\":\"mantis151-hnd.tokbox.com\",\"messagingUrl\":\"wss://mantis151-hnd.tokbox.com:443/rumorwebsocketsv2\",\"version\":\"v2.21.2\",\"partnerId\":\"39067782\",\"widgetType\":\"Subscriber\",\"width\":0,\"height\":0,\"audioTrack\":true,\"hasAudio\":true,\"subscribeToAudio\":true,\"audioVolume\":100,\"videoTrack\":true,\"connectionId\":\"964dde37-7282-422a-9dbe-348bfa3d823c\",\"hasVideo\":false,\"subscribeToVideo\":true,\"congestionLevel\":null,\"streamId\":\"89ef2861-c94b-48f4-9a62-e937c566dd18\",\"subscriberId\":\"4d1ecdfd-1660-4d90-bb65-552fde8eeda0\",\"remoteConnectionId\":\"14e4515f-7719-4c47-84d7-76fffff0855b\",\"peerId\":\"prism.mantis151-hnd.tokbox.com\",\"sourceStreamId\":\"ROUTED\",\"timeStamp\":1641740377543.3,\"period\":30,\"audioRecvPackets\":1499,\"audioRecvPacketsLost\":1,\"audioRecvBytes\":117795,\"videoRecvPackets\":0,\"videoRecvPacketsLost\":0,\"videoRecvBytes\":0,\"videoFramesReceived\":0,\"useDtx\":false,\"audioLocalCandidateType\":\"prflx\",\"audioLocalAddress\":\"113.200.174.7:39425\",\"audioRemoteCandidateType\":\"host\",\"audioRemoteAddress\":\"18.180.159.247:34792\",\"audioTransportType\":\"udp\",\"audioLocalRelayProtocol\":\"\",\"audioCodec\":\"opus\",\"videoCodec\":null,\"videoFrameRateReceived\":null,\"videoCodecChangeCount\":0,\"audioCodecChangeCount\":0,\"offerMessagesReceived\":1,\"dataChannels\":{\"sentMessages\":0,\"recvMessages\":0},\"clientInstanceId\":\"ed6e2306-9292-42ce-ab2f-c96c2add9c7b\"}",
    "method": "POST"
  });
  ```

  

- batch

  ```js
  fetch("https://track.miro.com/api/v1/batch", {
    "headers": {
      "authorization": "Basic NnhBODNMTE9XVDNwQ2JxSDMzUXVSdWFnQjNVMTJ3WlM6",
      "content-type": "application/json"
    },
    "referrer": "",
    "referrerPolicy": "strict-origin-when-cross-origin",
    "body": "{\"batch\":[{\"sentAt\":\"2022-01-09T15:07:18.440Z\",\"timestamp\":\"2022-01-09T15:07:15.858Z\",\"context\":{\"library\":{\"name\":\"miroClient\",\"version\":\"1.12406.3\"},\"page\":{\"referrer\":\"\",\"path\":\"/app/board/uXjVOXYiRO4=/\",\"search\":\"\",\"title\":\"My First Board, Online Whiteboard for Visual Collaboration\",\"url\":\"https://miro.com/app/board/uXjVOXYiRO4=/\",\"inIframe\":false},\"userAgent\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\"},\"messageId\":\"ajs-f407cd3ea57c4fa18152cab7bb49a778\",\"event\":\"widgetEditStarted\",\"properties\":{\"widgetType\":6,\"widgetId\":\"0\",\"widgetToken\":3,\"screenX\":-238,\"screenY\":-33.5,\"canvasX\":-503,\"canvasY\":-199.5,\"canvasWidth\":100,\"canvasHeight\":100,\"screenWidth\":100,\"screenHeight\":100,\"metaDataAppIds\":[],\"shapeType\":3,\"textLen\":0,\"scale\":1,\"userId\":\"3458764516215837984\",\"userType\":\"REGULAR\",\"userRole\":\"student\",\"userBoardRole\":\"OWNER\",\"firstSession\":true,\"clientId\":\"2707495219\",\"boardId\":\"uXjVOXYiRO4%3D\",\"toolType\":\"CURSOR\",\"appType\":0,\"navigationMode\":0,\"clientVersion\":\"1.12406.3\",\"accountId\":\"3458764516215766358\",\"deviceOs\":\"Windows\",\"appMode\":\"full\",\"browser_name\":\"Chrome\",\"browser_version\":\"97.0\"},\"anonymousId\":\"31aa081f-64aa-4471-8aac-6422a30250ba\",\"userId\":\"3458764516215837984\",\"type\":\"track\"},{\"sentAt\":\"2022-01-09T15:07:18.440Z\",\"timestamp\":\"2022-01-09T15:07:15.868Z\",\"context\":{\"library\":{\"name\":\"miroClient\",\"version\":\"1.12406.3\"},\"page\":{\"referrer\":\"\",\"path\":\"/app/board/uXjVOXYiRO4=/\",\"search\":\"\",\"title\":\"My First Board, Online Whiteboard for Visual Collaboration\",\"url\":\"https://miro.com/app/board/uXjVOXYiRO4=/\",\"inIframe\":false},\"userAgent\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\"},\"messageId\":\"ajs-201d16e3be9741ff872282ee538f1bdd\",\"event\":\"widgetTokenizerUpdated\",\"properties\":{\"widgetType\":6,\"widgetId\":\"3458764516216839258\",\"widgetToken\":3,\"screenX\":-238,\"screenY\":-33.5,\"canvasX\":-503,\"canvasY\":-199.5,\"canvasWidth\":100,\"canvasHeight\":100,\"screenWidth\":100,\"screenHeight\":100,\"metaDataAppIds\":[],\"shapeType\":3,\"scale\":1,\"userId\":\"3458764516215837984\",\"userType\":\"REGULAR\",\"userRole\":\"student\",\"userBoardRole\":\"OWNER\",\"firstSession\":true,\"clientId\":\"2707495219\",\"boardId\":\"uXjVOXYiRO4%3D\",\"toolType\":\"CURSOR\",\"appType\":0,\"navigationMode\":0,\"clientVersion\":\"1.12406.3\",\"accountId\":\"3458764516215766358\",\"deviceOs\":\"Windows\",\"appMode\":\"full\",\"browser_name\":\"Chrome\",\"browser_version\":\"97.0\"},\"anonymousId\":\"31aa081f-64aa-4471-8aac-6422a30250ba\",\"userId\":\"3458764516215837984\",\"type\":\"track\"}],\"writeKey\":\"6xA83LLOWT3pCbqH33QuRuagB3U12wZS\"}",
    "method": "POST"
  });
  ```

- ClientEvent 记日志

  ```js
  fetch("https://hlg.tokbox.com/prod/logging/ClientEvent", {
    "headers": {
      "accept": "text/plain",
      "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
      "content-type": "application/json",
      "sec-ch-ua": "\" Not;A Brand\";v=\"99\", \"Google Chrome\";v=\"97\", \"Chromium\";v=\"97\"",
      "sec-ch-ua-mobile": "?0",
      "sec-ch-ua-platform": "\"Windows\"",
      "sec-fetch-dest": "empty",
      "sec-fetch-mode": "cors",
      "sec-fetch-site": "cross-site",
      "Referer": "https://miro.com/",
      "Referrer-Policy": "origin"
    },
    "body": "{\"guid\":\"a1ca9710-386e-4f0d-933e-fcba8fa89b52\",\"clientVersion\":\"js-2.21.2\",\"buildHash\":\"36aba9d71\",\"source\":\"https://miro.com/app/board/uXjVOXYiRO4=/\",\"logVersion\":\"2\",\"apiServer\":\"https://api-standard.opentok.com\",\"clientSystemTime\":1641740770589,\"sessionId\":\"1_MX4zOTA2Nzc4Mn5-MTY0MTczOTAyOTY3NH43ZUNnYmdyLzBEVUYzcW9LZUlZM1dGbUt-fg\",\"mediaServerName\":\"mantis151-hnd.tokbox.com\",\"relayServer\":\"turnserver-5699b5d845-9b7xw-apne1.proxy.prod.tokbox.com\",\"p2p\":false,\"messagingServer\":\"mantis151-hnd.tokbox.com\",\"messagingUrl\":\"wss://mantis151-hnd.tokbox.com:443/rumorwebsocketsv2\",\"version\":\"v2.21.2\",\"partnerId\":\"39067782\",\"action\":\"ReportIssue\",\"variation\":\"Event\",\"connectionId\":\"1a58a683-e10b-41f6-9c31-cc6d99b0f526\",\"payload\":{\"reportIssueId\":\"6ed2dd09-2c87-4b68-9ce4-1acb752d9038\"},\"clientInstanceId\":\"ed6e2306-9292-42ce-ab2f-c96c2add9c7b\"}",
    "method": "POST"
  });
  ```

  





